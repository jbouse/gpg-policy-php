service: gpg-policy

plugins:
    - ./vendor/bref/bref

custom:
    efsAccessPoint: fsap-04be15fa8193513fa
    LocalMountPath: /mnt/data
    securityGroup: sg-0f1add0101223a1a1

provider:
    name: aws
    region: us-east-1
    runtime: provided.al2
    environment:
        APP_ENV: prod
        DATA_DIR: ${self:custom.LocalMountPath}
        POLICY_PREFIX: jbouse
        POLICY_OWNER: 'Jeremy T. Bouse'
    iam:
        role:
            managedPolicies:
                - arn:aws:iam::aws:policy/AmazonElasticFileSystemClientReadOnlyAccess

package:
    patterns:
        - '!node_modules/**'
        - '!.vscode/**'
        - '!.pytest_cache/**'
        - '!__pycadche__/**'
        - '!tests/**'
        - "!var/**"
        - '!*.local'

functions:
    website:
        handler: public/index.php
        description: 'GNU Privacy Guard Policy Manager'
        memorySize: 1024
        timeout: 28 # in seconds (API Gateway has a timeout of 29 seconds)
        layers:
            - ${bref:layer.php-83-fpm}
            - arn:aws:lambda:us-east-1:580247275435:layer:LambdaInsightsExtension:38
        vpc:
            securityGroupIds:
                - ${self:custom.securityGroup}
            subnetIds:
                - subnet-0461db9cf1be1cc67
                - subnet-02200213fe2e5874b
                - subnet-00b7e0292352c818b
                - subnet-08afc525ab17fb6cc
                - subnet-0a47ca1b571466642
                - subnet-0113a250fe8a3f8ce
        fileSystemConfig:
            arn: 'arn:aws:elasticfilesystem:${self:provider.region}:072105303426:access-point/${self:custom.efsAccessPoint}'
            localMountPath: '${self:custom.LocalMountPath}'
        events:
            -   httpApi: '*'
